# Руководство по разработке hermione-тестов

`hermione-тесты` — это [интеграционные тесты](http://www.intuit.ru/studies/courses/1040/209/lecture/5412), для разработки и запуска которых используется утилита [Hermione](https://github.com/gemini-testing/hermione). В основе утилиты лежат [WebdriverIO](http://webdriver.io/) и [Mocha](https://mochajs.org) с рядом дополнительных возможностей, упрощающих тестирование: разработка тестов с использованием уже знакомых инструментов, параллельный запуск тестов, повторное выполнение тестов отмеченных как не пройденные и т. п.

Как правило, тестирование функциональности сервиса заключается в проверке соответствия между реальным и ожидаемым поведением при взаимодействии его компонентов. Выполняется путем повторения пользовательского ввода в браузере и получения некоторого предполагаемого результата <!-- на основе данных для тестирования 
проверка соответствия между реальным и ожидаемым поведением программы, осуществляемая на конечном наборе тестов, выбранном определенным образом -->

Довольно часто такие тесты могут состоять из переходов по нескольким страницам, ввода данных в различные формы и поля, операции подтверждения и отмены действий и проверки результатов. Обычно такими тестами выполняется проверка процессов регистрации на сайте, входа в систему, операций над учетной записью пользователя, изменения настроек, сложных операций по получению данных, и тому подобного.  

Документ содержит общие сведения о конфигурации тестовой среды, описание основных действий для разрабоки тестов и вариантов их запуска, в зависимости от сервиса (СЕРП, Мультимедиа).

- [Конфигурация среды тестирования](#setup-env)
- [Установка и настройка](#setup-hermione) 
- [Расположение тестов в файловой системе проекта](#fs)
- [Этапы разработки тестов]() 
- Cоздание тестов  
- [Миграция с тестов java на javascript]()  
- [Генерация тестовых данных]()
- [Запуск тестов]()
  - [в удаленном гриде]()
  - [локальном гриде]()
  - [в TeamCity]()
- [Отчеты]()

<a name="setup-env"></a>
## Конфигурация среды тестирования

Чтобы разрабатывать и выполнять тесты, помимо утилиты `Hermione`, понадобятся следующие програмнные средства:

* [Selenium Server](https://github.com/vvo/selenium-standalone/blob/master/README.md) — инструмент, необходимый для разработки тестов с использованием [WebdriverIO](http://webdriver.io/) и запуска тестов в локальном [Selenium Grid](https://wiki.yandex-team.ru/selenium/).
* Кэширующий сервер, для локальной разработки и тестирования проекта в зависимости от сервиса :
  * [node-report](https://github.yandex-team.ru/mm-interfaces/fiji/blob/dev/README.md#node-report) (Мультимедиа).
  * [templar](https://github.yandex-team.ru/nodereport/templar) (СЕРП).<br> **NB** Подключен в виде [плагина](https://github.com/gemini-testing/hermione#plugins) `hermione-templar`, [пример](https://github.yandex-team.ru/serp/web4/blob/dev/hermione/package.json#L10) подключения в `web4`. 
* [GitLFS](https://wiki.yandex-team.ru/search-interfaces/testing/layout/git-lfs/#ustanovka) — клиент Git, который организует хранилище больших файлов и позволяет хранить в репозитории не сами файлы, а ссылки на них. Используется для хранения тестовых данных (только для `templar` и `web4`).

<a name="setup-hermione"></a>
## Установка и настройка `Hermione`

Устновка пакета выполняется из корня проекта с помощью команды (рекомендуется локальная установка):

```bash
npm install hermione
```

Настройка утилиты осуществляется в файле `.hermione.conf.js`, расположенном в корне проекта.
Он должен содержать, как минимум, две обязательные секции:

 * [specs](https://github.com/gemini-testing/hermione#specs) — список путей к папкам с  hermione-тестами.
 * [browsers](https://github.com/gemini-testing/hermione#browsers) — список браузеров для запуска тестов. 

Подробнее читайте в разделе документации [Quick Start](https://github.com/gemini-testing/hermione#quick-start). 

**СЕРП**  Обратите внимание, что в `package.json` проекта `web4` нет зависимостей от `templar` или `hermione`. Необходимые пакеты нужно установить самостоятельно:

```
 web4$ cd hermione && npm i --production && cd ..
```
**Важно!**  Если нужно добавить пакеты для hermione-тестов, добавьте их в `web4/hermione/package.json` и НЕ добавляйте в `web4/package.json`.

<a name="fs"></a>
### Расположение тестов и тестовых данных в cтруктуре проекта

(Вариант подзаголовка: Структура тестов и размещение в проекте)

Как правило, для реализации тестов пользовательского интерфейса с большим колличеством полей ввода и поведением приложения зависящем от введденных данных
ти виды тестов особенно полезны для пользовательского интерфейса с большим количеством полей, или там, где поведение приложения могут изменяться в зависимости от значений, введенных пользователем. Техника тестирования DDT позволяет использовать единожды написанный тест для проверки различных тестовых наборов данных. Эти наборы, как правило, хранятся отдельно от скриптов во внешних файлах или загружаются из базы данных.

Для реализации тестов


В большинстве случаев, реализация тестов включает
- тестовые сценарии
- тестовые данные

Тесты хранятся в файлах с расширением `*.js` в  папках, указаных в секции `specs` конфигурационного файла `.hermione.conf.js`.  

Тестовые данные  представляют собой стабильный набор данныхдля каждого теста хранятся в виде файла, содержащего закешированные данные. Данные полученны при запросе к удаленным источникам сервиса при выполении определенного теста. Расположение файла зависит от сервиса и настроек его кэширующего сервера. Дамп можно использовать также для локальной разработки тестов.

**СЕРП** В `web4`:

* тесты хранятся в папке `hermione/test-suites/<уровень переопределения>`;
* данные хранятся в папке `hermione/test-data/<id-теста из TestPalm>/<уровень переопределения>`, с помощью [GitLFS](https://wiki.yandex-team.ru/search-interfaces/testing/layout/git-lfs/#ustanovka). 


## Запуск тестов
Способы запуска тестов:

* [Локальный запуск в удаленном Selenium Grid](#) через SSH-тунель (по умолчанию) (тоннель до прокси будет поднят автоматически и запустится выполнение тестов в нужных браузерах, в зависимости от тестируемой платформы);
* [Локальный запуск в локальном Selenium Grid](#);
* В ТeamСity в удаленном Selenium Grid при сборке PR.

Быстрая справка c кратким описанием опций:

```
hermione/node_modules/.bin/hermione --help
```


### Запуск в удаленном гриде

```bash
# Запустить все тесты во всех браузерах:
hermione/node_modules/.bin/hermione --play

# Запустить все тесты только в одном браузере:
hermione/node_modules/.bin/hermione --play -b desktop/firefox

# Запустить определенный тест ?

hermione/node_modules/.bin/hermione  ?
```

> **NB** Список браузеров определяетя в секции `browsers` файла `.hermione.conf.js`. 

**CЕРП**

```bash
#Запустить только десктопные тесты:
PLATFORM=desktop hermione/node_modules/.bin/hermione --play

#Запустить только десктопные тесты, только в одном браузере:
PLATFORM=desktop hermione/node_modules/.bin/hermione --play -b desktop/firefox
```

> **Внимание** Необходимо обязательно указывать платформу для запуска тестов в переменной `PLATFORM`. Иначе, тесты будут выполняться во всех доступных браузерах грида (мобильных, десктопных). Это приведет к падению тестов, предназначенных только для определенной платформы. 

Допустимые значения для переменной `PLATFORM`: `desktop`, `touch-pad`, `touch-phone` (указывать можно только одно из значений).


### Запуск в локальном гриде

В случае, если нет возможности использовать [общий Selenium Grid](https://selenium.yandex-team.ru/#quota/web4) для разработки и отладки тестов, можно их выполнять в локальном гриде.

Перед первым запуском тестов нужно:

* Установить [selenium-standalone](https://www.npmjs.com/package/selenium-standalone selenium-standalone):
 
```
npm i -g selenium-standalone
selenium-standalone install
```

Если при установке появилась ошибка, нужно установить Java, которая требуется для работы `selenium-standalone`. Cкачайте со [страницы](http://www.oracle.com/technetwork/java/javase/downloads/jre7-downloads-1880261.html) файл `jre-7u79-macosx-x64.dmg` и установите его. Затем добавьте в `PATH`, например так: `export JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk1.7.0_79.jdk/Contents/Home`.

Перед каждым запуском тестов следует:

* Запустить `selenium-standalone` в **отдельной** вкладке c помощью команды:

```
selenium-standalone start
```
* В команде запуска тестов указать адрес локального грида с помощью параметра `--grid <url хаба>`:

```
hermione/node_modules/.bin/hermione --play --grid http://127.0.0.1:4444/wd/hub`
```

URL хаба можно найти в логе запущенного `selenium-standalone` в строчке вида: `15:18:16.753 INFO - RemoteWebDriver instances should connect to: http://127.0.0.1:4444/wd/hub`.

>**Важно!** Если у вас отсутствует соединение с сетью, нужно отключить туннель до `gemini-gui.haze.yandex.net`: в файле `.hermione.conf.js` выключить `(js)plugins['hermione-tunnel'].enabled = false`. ???

## Отчеты

Результы выполнения тестов можно просмотреть:

* В консоли (локально).
* В конфигурации TeamCity (найти можно по номеру PR): 
   * с помощью `teamcity reporter`, отчет доступен на вкладке `Tests`.

![Картинка](file:hermione-report.jpg)

   * с помощью `allure reporter`, oтчет доступен на вкладке `Hermione Allure Report`.

![Изображение](https://jing.yandex-team.ru/files/gavryushin/SI%20%3A%3A%20SERP%20%3A%3A%20web4%20%3A%3A%20Pull%20requests%20%3A%3A%202.%20Hermione%20%3A%3A%20desktop%20>%20%234560%20%2803%20Mar%2016%2017%3A10%29%20>%20Overview%20—%20TeamCity%202016-03-03%2017-15-08.png)


## Этапы разработки тестов

Основные этапы при проведении тестирования приложения:

- **Тест план** (спецификацию) — текстовый документ, содержащий краткое словесное описание действий пользователя при использовании функциональности и ожидаемый результат. 

- **Тестовый сценарий** (test case) — это детализированное описание начальных условий, входных данных, действий пользователя и ожидаемого результата (или набор тестовых сценариев (test suite) — тестовые сценарии, объединенные в группу по некоему признаку, например, тестируемой функциональности).

- **Тестовые данные** (test data), конкретные значения на основе которых оценивается правильность выполнения тестов.
 
 
### Порядок разработки hermione-тестов 

- Разработчик, тестировщик именеджер совместно продумывают и состовляют спецификацию для тестируемой функциональности, для каждой платформы. Затем, сохраняют ее способом принятым на сервисе. Например, в файле репозитория, рядом с кодом или в системе хранения тестовых сценариев.
В СЕРПе сценарии хранятся в системе [TestPalm](https://testpalm.yandex-team.ru/serp) в секции «Steps» (см.[пример](https://testpalm.yandex-team.ru/testcase/serp-2458)).
- Менеджер и тестировщик описывает сценарии по принципу «Что дано/Что сделали/Что Получили».
[Пример сценария](https://st.yandex-team.ru/SERP-39936#1455118360000)
- Разработчик пишет код и реализует тестовые сценарии. 
- Тестировщик проверяет код тестов.
	
стеме управления тестированием [TestPalm](https://testpalm.yandex-team.ru/serp) в секции «Steps» ([Например](https://te- Менеджер, тестировщик и разработчик совместоно продумывают и составляют тестовые сценарии, которые затstpalm.yandex-team.ru/testcase/serp-2458)).
ем фиксируют в текстовом виде. Сценарии фиксируетя в текстовом виде, способом принятым в сервисе, например, в репозитории, рядом с кодом.   
В СЕРПе сценарии хранятся в си


<!-- 1. Разработчик, тестировщик и менеджер соместно составляют спецификациюпошагово сценарий действий пользователя и ожидаемый результат для некоторой функциональности (для каждой платформы). 
2. Фиксируют сценарий в системе управления тестированием [TestPalm](https://testpalm.yandex-team.ru/serp) в секции «Steps» или в репозитории, рядом с кодом. Например https://testpalm.yandex-team.ru/testcase/serp-2458
3. Разработчик создает задачу в ST для разработки новой функциональности и указывает в нем id теста из TestPalm.
И переписывает сценарий на терминах для hermione
см. https://st.yandex-team.ru/SERP-39936#1455118360000
4. Переписать описанные действия на JS c использованием mocha и webdriver.io+Chai -->
5.



### Миграция тестов с Java на JavaScript


<!-- https://testpalm.yandex-team.ru/serp/ - TestPalm хранилище сценариев действий пользователя (стандартные действия)
Содержит пошаговое описание. 
Каждый java-тест привязать к описанию сценария  testpalm по ID
(есть для авторстов и для ручных тестировщиков - отличаются признаком) -->

  
- Разработчик создает задачу в ST для переработки Java-теста и переносит в нее  `id` теста  и описание сценария (секции «Steps») из [TestPalm](https://testpalm.yandex-team.ru/serp).
- Определяет какие шаги в тесте может проверить с помощью `hermione`-тестов, а что с помощью `gemini`-тестов.
- В комментариях задачи переписывает часть спецификации теста, которая будет тестироваться с промощью `hermione`, в терминах приближенных к тестам в виде цепочки шагов «действие -> ожидаемый результат» [см. пример](https://st.yandex-team.ru/SERP-39936#1455118360000)
- Кодирует описанные действия c использованием `Mocha` и `Webdriver.io+Chai`
- Тестировщик проверяет код созданных `hermione-` и `gemini-`тестов на полноту и правильность выполнения.


### Cоздание тестового сецнария

Тесты разрабатываются с помощью следующих программных средств:

- [Mocha]() - ссылку апи 
- [Chai]() можно подключить любую библиотеку ассертов (настраивается в конфиге гермионы)
- [WebdriverIO]- ссылку на апи
- [Sinon]()(можно подключить любую библиотеку ассертов (настраивается в конфиге гермионы)
<!-- - Page Object - не нужно 
пример про автораизацию -->

Рассмотрим поэтапную разработку тестов на простом примере появления колдунщика погоды:  

1. Cоздаем тест-план

```
В инпут ввел текст: погода в симферополе
Нажал кнопку «Найти»
Появился колдунщик с погодой
```

2. Создаем тестовый сценарий

```
waitForWisible ('.z-weather') //элемент погоды определяется по селектору
```




#### Тест с добавлением Page Object (bem-page-object) (ссылка)


## Генерация тестовых данных

Тестирование выполняется на основе данных для тестов. Они представляют собой набор
конкретных значений для проверки некоторой функциональности приложения и отражают вариации ее использования. 

На основе тестовых данных будет сформирована тестовая страница на которой будут выполнятся тесты 

Тестовые данные хранятся в виде дампа в файловой системе, полученного после обращения к удаленным источникам сервиса.
Это позволяет их использовать повторно при выполнении тестов.

Стабильный набор данных используется каждый раз при выполнении тестов
Задает:
- начальные условия
- ...
- ....


 ### templar 

Для локальной разработки и тестирования проекта используется [templar](https://github.yandex-team.ru/nodereport/templar) — кэшируюший сервер. 

[Подробная документация](https://wiki.yandex-team.ru/nodereport/templar/faq/)

### Установка и настройка

нужно? 

#### Работа с кешами репорта
- Запуск тестов по живым данным репорта (при разработке теста):

```
hermione/node_modules/.bin/hermione
```

- Запуск поверх сохраненных ответов репорта (в частности при запуске в TeamCity):
```
hermione/node_modules/.bin/hermione --play
``` 
- Запись ответов репорта в файл (после того как написали и отладили тест), дамп ответа нужно будет закоммитить:
```
 hermione/node_modules/.bin/hermione --save
 ```

Подготовить данные для тестов можно следующим образом

> Отладка тестов выполняется локально:

- Запустить все текущие тесты проекта с опцией `--play` и убедиться, что ничего не падает (мигает). Если есть проблемные тесты, найти автора такого теста для исправления ошибок.

```
hermione/node_modules/.bin/hermione --play
```

- Написать тест и убедиться, что он выполняется правильно, запустив его без опций 
```
hermione/node_modules/.bin/hermione hermione/test-suites/desktop/mytest.js
```

- Сохранить дампы данных своих тестов посредством опции `--save`. Изменения в дампах чужих тестов (пока нет опции запуска `--grep` FEI-1829[ --hermione: добавить опцию grep-- ]( matumbaman )) откатить.
decribe.only
it.only
cопцией --save сохранить данные только для отмеченных only тестов


```
hermione/node_modules/.bin/hermione hermione/test-suites/desktop/mytest.js 
``` 

- Выполнить еще раз все тесты с опцией `--play`. Убедиться, что ваши тесты  выполняются поверх сохраненных данных (в консоли не должно быть ошибок). Желательно несколько раз, особенно, если в тесте присутствуют AJAX-запросы.   
  
- Если все тесты прошли успешно, нужно закоммитить `test-suite` и `test-data` своих тестов в репозиторий проекта. Учитывайте, что `test-data` комитится в [git-lf]()(только web4)

- В отчетах для вашего PR на GitHub-е проверьте, что ваши тесты в TeamCity прошли.


