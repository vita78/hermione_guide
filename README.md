# Руководство по разработке hermione-тестов

`Hermione-тесты` — это функциональные тесты, которые разрабатываются и запускаются в браузере с помощью утилиты [Hermione](https://github.com/gemini-testing/hermione). Утилита основана на  [WebdriverIO](http://webdriver.io/) и [Mocha](https://mochajs.org) с рядом полезных доработок.

 Функциональные тесты проверяют правильность работы сервиса путем эмуляции действий пользователя в браузере и сверкой полученного результата.

Как правило, тесты состоят из:

- набора тестовых сценацриев, которые копируют сценарии использования и определяют функциональность приложения. 
- набора тестовых данных (дамп), на основе которых проверяется правильность выполнения тестов.

Довольно часто такие тесты могут содержать переходы по нескольким страницам, ввод данных в различные формы и поля, операции подтверждения и отмены действий и проверки результатов. Обычно такими тестами выполняется проверка процессов регистрации на сайте, входа в систему, операций над учетной записью пользователя, изменения настроек, сложных операций по получению данных, и тому подобного. <!-- В большинстве случаев тест копирует сценарии использования, определяющие функциональность и устройство вашего приложения. --> 

Документ содержит общие сведения об инструменте `hermione` и разрабатываемых с его помощью теcтах, описание основных действий для разрабоки тестов и вариантов их запуска, в зависимости от сервиса (СЕРП, Мультимедия  ?).

- [Конфигурация среды тестирования]()
- [Установка и настройка]() 
- [Расположение тестов в файловой системе проекта]()
- [Этапы разработки тестов]() 
  - [Планирование (подготовка) тестового сценария]() 
  - [Генерация тестовых данных]()
  - [Пример тестового сценария]() 
  - [Миграция с тестов java на javascript]()  
- [Запуск тестов]()
  - [в удаленном гриде]()
  - [локальном гриде]()
  - [в TeamCity]()
- [Отчеты]()

## Настройка среды
Для разработки и выполнения hermione-тестов, помиомо утилиты `hermione`, понадобятся следующие програмнные средства:

* [NodeJS](https://nodejs.org/en/) не ниже 4 версии. (нужно ?)
* [Selenium Server](https://github.com/vvo/selenium-standalone/blob/master/README.md) — сервер, необходимый для запуска тестов в локальном [Selenium Grid](https://wiki.yandex-team.ru/selenium/).
* Кэширующий сервер, для локальной разработки и тестирования сервиса в зависимости от сервиса :
  * Мультимедия: [node-report](https://github.yandex-team.ru/mm-interfaces/fiji/blob/dev/README.md#node-report).
  * СЕРП: [templar](https://github.yandex-team.ru/nodereport/templar) — подключен в виде [плагина](https://github.com/gemini-testing/hermione#plugins) `hermione-templar`, [пример в web4](https://github.yandex-team.ru/serp/web4/blob/dev/hermione/package.json#L10). 
* [GitLFS](https://wiki.yandex-team.ru/search-interfaces/testing/layout/git-lfs/#ustanovka) — клиент Git, который обеспечивает организацию хранилища больших файлов и позволяет хранить в репозитории не сами файлы, а ссылки на них. Используется для хранения тестовых данных (только для `templar` и `web4`).


## Установка и настройка `hermione`

Устновка пакета выполняется из корня проекта с помощью команды (рекомендуется локальная установка):

```bash
npm install hermione
```

Настройка утилиты осуществляется в файле `.hermione.conf.js`, расположенном в корне проекта.
Он должен содержать, как минимум, две обязательные секции:

 * [specs](https://github.com/gemini-testing/hermione#specs) — список путей к папкам, где распологаются hermione-тесты.
 * [browsers](https://github.com/gemini-testing/hermione#browsers) — список браузеров, в которых будут запускаться тесты. 

Подробнее про установку и настройку утилиты читайте в разделе документации [Quick Start](https://github.com/gemini-testing/hermione#quick-start). 


**СЕРП**  Обратите внимание, что в `package.json` проекта `web4` нет зависимостей от `templar` или `hermione`. Необходимые пакеты нужно установить самостоятельно:

```
 web4$ cd hermione && npm i --production && cd ..
```
**Важно!**  Если нужно добавить пакеты для hermione-тестов, добавьте их в `web4/hermione/package.json` и НЕ добавляйте в `web4/package.json`.

### Расположение тестов и тестовых данных в файловой системе проекта

Тесты хранятся в файлах с расширением `*.js` в  папках, которые указаны в секции `specs` конфигурационного файла `.hermione.conf.js`.  

В `web4` файлы хранятся в папке `hermione/test-suites/<уровень переопределения>`

Расположение тестовых данных зависит от сервиса и от настроект кэширующего сервера.

В `web4` данные хранятся в папке `hermione/test-data/<id-теста из TestPalm>/<уровень переопределения>` с помощью [GitLFS](https://wiki.yandex-team.ru/search-interfaces/testing/layout/git-lfs/#ustanovka). 


## Запуск
Способы запуска тестов:

* [Локальный запуск в удаленном Selenium Grid](#) через SSH-тунель (по умолчанию) (тоннель до прокси будет поднят автоматически и запустится выполнение тестов в нужных браузерах, в зависимости от тестируемой платформы);
* [Локальный запуск в локальном Selenium Grid](#);
* В ТeamСity в удаленном Selenium Grid при сборке PR.

Быстрая справка c кратким описанием опций:

```
hermione/node_modules/.bin/hermione --help
```


### Запуск в удаленном гриде

```bash
# Запустить все тесты во всех браузерах:
hermione/node_modules/.bin/hermione --play

# Запустить все тесты только в одном браузере:
hermione/node_modules/.bin/hermione --play -b desktop/firefox

# Запустить определенный тест ?

hermione/node_modules/.bin/hermione  ?
```

> **NB** Список браузеров определяетя в секции `browsers` файла `.hermione.conf.js`. 

**CЕРП**

```bash
#Запустить только десктопные тесты:
PLATFORM=desktop hermione/node_modules/.bin/hermione --play

#Запустить только десктопные тесты, только в одном браузере:
PLATFORM=desktop hermione/node_modules/.bin/hermione --play -b desktop/firefox
```

> **Внимание** Необходимо обязательно указывать платформу для запуска тестов в переменной `PLATFORM`. Иначе, тесты будут выполняться во всех доступных браузерах грида (мобильных, десктопных). Это приведет к падению тестов, предназначенных только для определенной платформы. 

Допустимые значения для переменной `PLATFORM`: `desktop`, `touch-pad`, `touch-phone` (указывать можно только одно из значений).


### Запуск в локальном гриде

В случае, если нет возможности использовать [общий Selenium Grid](https://selenium.yandex-team.ru/#quota/web4) для разработки и отладки тестов, можно их выполнять в локальном гриде.

Перед первым запуском тестов нужно:

* Установить [selenium-standalone](https://www.npmjs.com/package/selenium-standalone selenium-standalone):
 
```
npm i -g selenium-standalone
selenium-standalone install
```

Если при установке появилась ошибка, нужно установить Java, которая требуется для работы `selenium-standalone`. Cкачайте со [страницы](http://www.oracle.com/technetwork/java/javase/downloads/jre7-downloads-1880261.html) файл `jre-7u79-macosx-x64.dmg` и установите его. Затем добавьте в `PATH`, например так: `export JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk1.7.0_79.jdk/Contents/Home`.

Перед каждым запуском тестов следует:

* Запустить `selenium-standalone` в **отдельной** вкладке c помощью команды:

```
selenium-standalone start
```
* В команде запуска тестов указать адрес локального грида с помощью параметра `--grid <url хаба>`:

```
hermione/node_modules/.bin/hermione --play --grid http://127.0.0.1:4444/wd/hub`
```

URL хаба можно найти в логе запущенного `selenium-standalone` в строчке вида: `15:18:16.753 INFO - RemoteWebDriver instances should connect to: http://127.0.0.1:4444/wd/hub`.

>**Важно!** Если у вас отсутствует соединение с сетью, нужно отключить туннель до `gemini-gui.haze.yandex.net`: в файле `.hermione.conf.js` выключить `(js)plugins['hermione-tunnel'].enabled = false`. ???

## Отчеты

Результы выполнения тестов можно просмотреть:

* В консоли (локально).
* В конфигурации TeamCity (найти можно по номеру PR): 
   * с помощью `teamcity reporter`, отчет доступен на вкладке `Tests`.

![Картинка](file:hermione-report.jpg)

   * с помощью `allure reporter`, oтчет доступен на вкладке `Hermione Allure Report`.

![Изображение](https://jing.yandex-team.ru/files/gavryushin/SI%20%3A%3A%20SERP%20%3A%3A%20web4%20%3A%3A%20Pull%20requests%20%3A%3A%202.%20Hermione%20%3A%3A%20desktop%20>%20%234560%20%2803%20Mar%2016%2017%3A10%29%20>%20Overview%20—%20TeamCity%202016-03-03%2017-15-08.png)

## Этапы разработки тестов

Основные этапы для разработки тестов:

- Составить тестовый сценарий для проверки новой функциональности.
- Разработать тест.
- Сгенерировать тестовые данные.

В большинстве случаев, тест представляет собой последовательность шагов, повторяющих действия пользователя в браузере определяющих некоторую функциональность и проверку ожидаемого результа.

Тестовый сценарий (test case) — это описание начальных условий, входных данных, действий пользователя и ожидаемого результата.

Группа тестовых сценариев, объединенных по некоему признаку (например, тестируемой функциональности) образуют тестовый набор (test suite).

Тестовые данные - фиксированный набор данных для ....

### Планирование тестового сценария 
- Разработчик, тестировщик и менеджер соместно составляют и описывают человеческим языком пошагово сценарий действий пользователя и ожидаемый результат для некоторой функциональности (для каждой платформы).
???- Менеджер, тестировщик и разработчик совместоно продумывают и составляют тестовые сценарии, которые затем фиксируют в текстовом виде. Сценарии фиксируетя в текстовом виде, способом принятым в сервисе, например, в репозитории, рядом с кодом.   
В СЕРПе сценарии хранятся в системе управления тестированием [TestPalm](https://testpalm.yandex-team.ru/serp) в секции «Steps» ([Например](https://testpalm.yandex-team.ru/testcase/serp-2458)).
- Менеджер и тестировщик описывает сценарии по принципу Что дано/Что сделали/Что Получили.
[Пример сценария](https://st.yandex-team.ru/SERP-39936#1455118360000)
- Разработчик пишет код и реализует тестовые сценарии 
- Тестировщик проверяет код тестов.

### Миграция тестов с java на javascritp

https://testpalm.yandex-team.ru/serp/ - TestPalm хранилище сценариев действий пользователя (стандартные действия)
Содержит пошаговое описание. 
Каждый java-тест привязать к описанию сценария  testpalm по ID
(есть для авторстов и для ручных тестировщиков - отличаются признаком)

  
- Разработчик создает задачу в ST для разработки теста и привязывает ее к `id` теста из TestPalm.
- Определяет что тестируется с помощью `hermione` или `gemini`.
- Переписывает текстовый сценарий из `TestPalm`  в терминах  приближенных к тестам 
[см.](https://st.yandex-team.ru/SERP-39936#1455118360000) в виде цепочки шагов «действие -> ожидаемый результат»
- Переписывает описанные действия на JS c использованием `mocha` и `webdriver.io+Chai`
- Тестировщик ревьюит код тестов и gemini.



### Разработка теста

1. Разработчик, тестировщик и менеджер соместно составляют и описывают человеческим языком пошагово сценарий действий пользователя и ожидаемый результат для некоторой функциональности (для каждой платформы).
Например:
```
Cмена величин
- Открываем выпадушку с величинами ’в’
- Выбираем вариант: EUR
- Открываем выпадушку с величинами ‘из’
- Выбираем вариант: EUR
- Клик: очистка поле ввода ‘из’
- Вводим ‘10000000000000’ в инпут: ‘поле ввода ’из’‘
- Клик: очистка поле ввода ’в’
- Вводим ‘10000000000000’ в инпут: ‘поле ввода ’в’’
```
2. Фиксируют сценарий в системе управления тестированием [TestPalm](https://testpalm.yandex-team.ru/serp) в секции «Steps» или в репозитории, рядом с кодом. Например https://testpalm.yandex-team.ru/testcase/serp-2458
3. Разработчик создает задачу в ST для разработки новой функциональности и указывает в нем id теста из TestPalm.
И переписывает сценарий на терминах для hermione
см. https://st.yandex-team.ru/SERP-39936#1455118360000
4. Переписать описанные действия на JS c использованием mocha и webdriver.io+Chai
5.


### Cоздание теста
 Тесты разрабатываются с помощью следующх средств:
 - Mocha - ссылку апи 
 - Chai можно подключить любую библиотеку ассертов (настраивается в конфиге гермионы)
 - WebdriverIO- ссылку на апи
 - Page Object - не нужно 
 - Sinon можно подключить любую библиотеку ассертов (настраивается в конфиге гермионы)


#### Тестовый сценарий

пример про автораизацию

в инпут ввел текст: погода в симферополе
нажал кнопку
появился колдунщик с погодой
waitForWisible ('.z-weather') //элемент погоды определяется по селектору


#### Тест 



#### Тест с добавлением Page Object (bem-page-object) (ссылка)


## Генерация тестовых данных

Тестирование выполняется на основе данных для тестов. Они представляют собой набор
конкретных значений для проверки некоторой функциональности приложения и отражают вариации ее использования. 

На основе тестовых данных будет сформирована тестовая страница на которой будут выполнятся тесты 

Тестовые данные хранятся в виде дампа в файловой системе, полученного после обращения к удаленным источникам сервиса.
Это позволяет их использовать повторно при выполнении тестов.

Стабильный набор данных используется каждый раз при выполнении тестов
Задает:
- начальные условия
- ...
- ....


 ### templar 

Для локальной разработки и тестирования проекта используется [templar](https://github.yandex-team.ru/nodereport/templar) — кэшируюший сервер. 

[Подробная документация](https://wiki.yandex-team.ru/nodereport/templar/faq/)

### Установка и настройка

нужно? 

#### Работа с кешами репорта
- Запуск тестов по живым данным репорта (при разработке теста):

```
hermione/node_modules/.bin/hermione
```

- Запуск поверх сохраненных ответов репорта (в частности при запуске в TeamCity):
```
hermione/node_modules/.bin/hermione --play
``` 
- Запись ответов репорта в файл (после того как написали и отладили тест), дамп ответа нужно будет закоммитить:
```
 hermione/node_modules/.bin/hermione --save
 ```

Подготовить данные для тестов можно следующим образом

> Отладка тестов выполняется локально:

- Запустить все текущие тесты проекта с опцией `--play` и убедиться, что ничего не падает (мигает). Если есть проблемные тесты, найти автора такого теста для исправления ошибок.

```
hermione/node_modules/.bin/hermione --play
```

- Написать тест и убедиться, что он выполняется правильно, запустив его без опций 
```
hermione/node_modules/.bin/hermione hermione/test-suites/desktop/mytest.js
```

- Сохранить дампы данных своих тестов посредством опции `--save`. Изменения в дампах чужих тестов (пока нет опции запуска `--grep` FEI-1829[ --hermione: добавить опцию grep-- ]( matumbaman )) откатить.
decribe.only
it.only
cопцией --save сохранить данные только для отмеченных only тестов


```
hermione/node_modules/.bin/hermione hermione/test-suites/desktop/mytest.js 
``` 

- Выполнить еще раз все тесты с опцией `--play`. Убедиться, что ваши тесты  выполняются поверх сохраненных данных (в консоли не должно быть ошибок). Желательно несколько раз, особенно, если в тесте присутствуют AJAX-запросы.   
  
- Если все тесты прошли успешно, нужно закоммитить `test-suite` и `test-data` своих тестов в репозиторий проекта. Учитывайте, что `test-data` комитится в [git-lf]()(только web4)

- В отчетах для вашего PR на GitHub-е проверьте, что ваши тесты в TeamCity прошли.

