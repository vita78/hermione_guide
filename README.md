# Руководство по разработке hermione-тестов

`hermione-тесты` — это [интеграционные тесты](http://www.intuit.ru/studies/courses/1040/209/lecture/5412), для разработки и запуска которых используется утилита [Hermione](https://github.com/gemini-testing/hermione). В основе утилиты лежат [WebdriverIO](http://webdriver.io/) и [Mocha](https://mochajs.org) с рядом дополнительных возможностей, упрощающих тестирование.  Помимо разработки тестов с использованием уже знакомых инструментов, обеспечивает параллельный запуск тестов, выполнение только определенного теста, повторное выполнение тестов отмеченных как не пройденные, подключение плагинов и кастомных команд.


Тестирование функциональности сервиса заключается в проверке того, что приложение работает в соответствии с ожиданиями. <!-- взаимодействия его компонентов и соответствия между реальным и ожидаемым поведением на основе тестовых данных. -->Выполняется путем повторения пользовательского ввода в браузере и получения некоторого предполагаемого результата.

Довольно часто такие тесты могут состоять из переходов по нескольким страницам, ввода данных в различные формы и поля, операции подтверждения и отмены действий и проверки результатов. Обычно такими тестами выполняется проверка процессов регистрации на сайте, входа в систему, операций над учетной записью пользователя, изменения настроек, сложных операций по получению данных, и тому подобного.  

Документ содержит общие сведения о конфигурации тестовой среды, описание основных действий для разрабоки тестов и вариантов их запуска, в зависимости от сервиса (СЕРП, Мультимедиа).

- Основные понятия
- [Конфигурация среды тестирования](#setup-env)
- [Установка и настройка hermione](#setup-hermione) 
- [Расположение тестов в файловой системе проекта](#fs)
[Запуск тестов](#run-tests)
  - [в удаленном гриде](#run-loc)
  - [локальном гриде](#run-remout)
  - [в TeamCity](#run-tc)
- [Отчеты](#reports)
- [Этапы разработки тестов](#steps) 
- [Миграция с тестов java на javascript](#migration)  
- [Cоздание тестов](#create-test)  
- [Генерация тестовых данных](#get-test-data)
- FAQ
- [Практики разработки](https://github.yandex-team.ru/mm-interfaces/fiji/blob/beste2epractices/e2e/readme.md)

## Основные понятия

- **Тест план** (спецификацию) — текстовый документ, содержащий краткое словесное описание действий пользователя при использовании функциональности и предпологаемый результат. 

- **Тестовый сценарий** (test case) — это детализированное описание начальных условий, входных данных, действий пользователя и ожидаемого результата. 

- **Тестовые данные** (test data), конкретные значения на основе которых оценивается правильность выполнения тестов.

- **Набор тестов** (test suite) – это комплект нескольких тестовых сценариев, объединенных в группу по некоему признаку, например, тестируемой функциональности. Пользователь может запустить все доступные тестовые сценарии в наборе тестов как одно непрерывное пакетное задание.


<a name="setup-env"></a>
## Конфигурация среды тестирования

Чтобы разрабатывать и выполнять тесты, помимо утилиты `Hermione`, понадобятся следующие програмнные средства:

* [Selenium Server](https://github.com/vvo/selenium-standalone/blob/master/README.md) — инструмент, необходимый запуска тестов в локальном [Selenium Grid](https://wiki.yandex-team.ru/selenium/).
* Кэширующий сервер, для локальной разработки и тестирования проекта в зависимости от сервиса :
  * [node-report](https://github.yandex-team.ru/mm-interfaces/fiji/blob/dev/README.md#node-report) (Мультимедиа).
  * [templar](https://github.yandex-team.ru/nodereport/templar) (СЕРП).<br> **NB** Подключен в виде [плагина](https://github.com/gemini-testing/hermione#plugins) `hermione-templar`, [пример](https://github.yandex-team.ru/serp/web4/blob/dev/hermione/package.json#L10) подключения в `web4`. 
* [GitLFS](https://wiki.yandex-team.ru/search-interfaces/testing/layout/git-lfs/#ustanovka) — клиент Git, который организует хранилище больших файлов и позволяет хранить в репозитории не сами файлы, а ссылки на них. Используется для хранения тестовых данных (только для `templar` и `web4`).

<a name="setup-hermione"></a>
## Установка и настройка `Hermione`

Устновка пакета выполняется из корня проекта с помощью команды (рекомендуется локальная установка):

```bash
npm install hermione
```

Настройка утилиты осуществляется в файле `.hermione.conf.js`, расположенном в корне проекта.
Он должен содержать, как минимум, две обязательные секции:

 * [specs](https://github.com/gemini-testing/hermione#specs) — список путей к папкам с  hermione-тестами.
 * [browsers](https://github.com/gemini-testing/hermione#browsers) — список браузеров для запуска тестов. 

Подробнее читайте в разделе документации [Quick Start](https://github.com/gemini-testing/hermione#quick-start). 

**СЕРП**  Обратите внимание, что в `package.json` проекта `web4` нет зависимостей от `templar` или `hermione`. Необходимые пакеты нужно установить самостоятельно:

```
 web4$ cd hermione && npm i --production && cd ..
```
**Важно!**  Если нужно добавить пакеты для hermione-тестов, добавьте их в `web4/hermione/package.json` и НЕ добавляйте в `web4/package.json`.

<a name="fs"></a>
### Расположение тестов и тестовых данных в cтруктуре проекта

(Вариант подзаголовка: Структура тестов и размещение в проекте)

Тестовые сценарии хранятся в файлах с расширением `*.js` в  папках, указаных в секции `specs` конфигурационного файла `.hermione.conf.js`. 

Для реализации тестирования помимо тестовых сценариев нужны наборы тестовых данных, на основе которых они выполняются. Эти данные, как правило, хранятся отдельно от тестов во внешних файлах или загружаются из базы данных. Расположение файлов зависит от сервиса и настроек его кэширующего сервера. 

Тестовый набор данных представляют собой автоматически полученные данные при выполнении запроса к удаленным источникам сервиса на изменяющихся входных данных теста. Они могут использоваться как при локальной разработке тестов, так и при удаленном запуске.

Подробрнее про подготовку тестовых данных читайте в разделе [Генерация тестовых данных](#get-test-data).

**СЕРП** В проекте `web4` тесты и их данные хранятся в отдельной папке `hermione`:

* тесты расположены в папке `hermione/test-suites/<уровень переопределения>`;
* данные расположены в папке `hermione/test-data/<id-теста из TestPalm>/<уровень переопределения>`, с помощью [GitLFS](https://wiki.yandex-team.ru/search-interfaces/testing/layout/git-lfs/#ustanovka). 

<a name="run-tests"></a>
## Запуск тестов

Способы запуска тестов:

* [Локальный запуск в удаленном Selenium Grid](#run-remout) через SSH-тунель (по умолчанию) (тоннель до прокси будет поднят автоматически и запустится выполнение тестов в нужных браузерах, в зависимости от тестируемой платформы);
* [Локальный запуск в локальном Selenium Grid](#run-loc);
* В ТeamСity в удаленном Selenium Grid при сборке PR.

Быстрая справка c кратким описанием опций:

```
hermione/node_modules/.bin/hermione --help
```

<a name="run-remout"></a>
### Запуск в удаленном гриде

```bash
# Запустить все тесты во всех браузерах:
hermione/node_modules/.bin/hermione --play

# Запустить все тесты только в одном браузере:
hermione/node_modules/.bin/hermione --play -b desktop/firefox

# Запустить определенный тест ?

hermione/node_modules/.bin/hermione  ?
```

> **NB** Список браузеров определяетя в секции `browsers` файла `.hermione.conf.js`. 

**CЕРП**

```bash
# Запустить только десктопные тесты:
PLATFORM=desktop hermione/node_modules/.bin/hermione --play

# Запустить только десктопные тесты, только в одном браузере:
PLATFORM=desktop hermione/node_modules/.bin/hermione --play -b desktop/firefox
```

> **Внимание** Необходимо обязательно указывать платформу для запуска тестов в переменной `PLATFORM`. Иначе, тесты будут выполняться во всех доступных браузерах грида (мобильных, десктопных). Это приведет к падению тестов, предназначенных только для определенной платформы. 

Допустимые значения для переменной `PLATFORM`: `desktop`, `touch-pad`, `touch-phone` (указывать можно только одно из значений).


<a name="run-loc"></a>
### Запуск в локальном гриде

В случае, если нет возможности использовать [общий Selenium Grid](https://selenium.yandex-team.ru/#quota/web4) для разработки и отладки тестов, можно их выполнять в локальном гриде.

Перед первым запуском тестов нужно:

* Установить [selenium-standalone](https://www.npmjs.com/package/selenium-standalone selenium-standalone):
 
```
npm i -g selenium-standalone
selenium-standalone install
```

Если при установке появилась ошибка, нужно установить Java, которая требуется для работы `selenium-standalone`. Cкачайте со [страницы](http://www.oracle.com/technetwork/java/javase/downloads/jre7-downloads-1880261.html) файл `jre-7u79-macosx-x64.dmg` и установите его. Затем добавьте в `PATH`, например так: `export JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk1.7.0_79.jdk/Contents/Home`.

Перед каждым запуском тестов следует:

* Запустить `selenium-standalone` в **отдельной** вкладке c помощью команды:

```
selenium-standalone start
```
* В команде запуска тестов указать адрес локального грида с помощью параметра `--grid <url хаба>`:

```
hermione/node_modules/.bin/hermione --play --grid http://127.0.0.1:4444/wd/hub`
```

URL хаба можно найти в логе запущенного `selenium-standalone` в строчке вида: `15:18:16.753 INFO - RemoteWebDriver instances should connect to: http://127.0.0.1:4444/wd/hub`.

>**Важно!** Если у вас отсутствует соединение с сетью, нужно отключить туннель до `gemini-gui.haze.yandex.net`: в файле `.hermione.conf.js` выключить `(js)plugins['hermione-tunnel'].enabled = false`. ???

<a name="report"></a>
## Отчеты

Результы выполнения тестов можно просмотреть:

* В консоли (локально).
* В конфигурации TeamCity (найти можно по номеру PR): 
   * с помощью `teamcity reporter`, отчет доступен на вкладке `Tests`.

![Картинка](file:hermione-report.jpg)

   * с помощью `allure reporter`, oтчет доступен на вкладке `Hermione Allure Report`.

![Изображение](https://jing.yandex-team.ru/files/gavryushin/SI%20%3A%3A%20SERP%20%3A%3A%20web4%20%3A%3A%20Pull%20requests%20%3A%3A%202.%20Hermione%20%3A%3A%20desktop%20>%20%234560%20%2803%20Mar%2016%2017%3A10%29%20>%20Overview%20—%20TeamCity%202016-03-03%2017-15-08.png)

<a name="steps"></a>
## Этапы разработки тестов
 
 - Разработчик, тестировщик именеджер совместно продумывают и состовляют спецификацию для тестируемой функциональности, для каждой платформы. Затем, сохраняют ее способом принятым на сервисе. Например, в файле репозитория, рядом с кодом или в системе хранения тестовых сценариев.
В СЕРПе сценарии хранятся в системе [TestPalm](https://testpalm.yandex-team.ru/serp) в секции «Steps» (см.[пример](https://testpalm.yandex-team.ru/testcase/serp-2458)).
- Менеджер и тестировщик описывает сценарии по принципу «Что дано/Что сделали/Что Получили».
[Пример сценария](https://st.yandex-team.ru/SERP-39936#1455118360000)
- Разработчик пишет код и реализует тестовые сценарии. 
- Тестировщик проверяет код тестов.
	
<a name="migration"></a>
### Миграция тестов с Java на JavaScript

- Разработчик создает задачу в ST для переработки автотеста на Java и переносит в нее  `id` теста  и описание сценария (секции «Steps») из [TestPalm](https://testpalm.yandex-team.ru/serp).
- Определяет какие шаги в тесте может проверить с помощью `hermione`-тестов, а что с помощью `gemini`-тестов (визуальную составляющую).
- В комментариях задачи переписывает часть спецификации теста, которая будет тестироваться с промощью `hermione`, в терминах приближенных к тестовым сценариям в виде цепочки шагов «действие -> ожидаемый результат» [см. пример](https://st.yandex-team.ru/SERP-39936#1455118360000)
- Кодирует описанные действия c использованием `Mocha` и `Webdriver.io+Chai`
- Тестировщик проверяет код созданных `hermione-` и `gemini-`тестов на полноту и правильность выполнения.

<a name="create-test"></a>
### Cоздание тестового сецнария

Для разработки и запуска тестов используются следующие библиотеки:

- [Mocha](https://mochajs.org) — содержит общие функции для тестирования, включая `describe` и `it`.
- [WebdriverIO](http://webdriver.io/) — содержит универсальный API для управления поведением браузеров. 
- [Chai](http://chaijs.com/) — поддерживает разнообразные функции для проверок и разные «стили» проверки результатов (в конфиге `hermione.conf.js` можно подключить любую библиотеку ассертов). 
- [Sinon](http://sinonjs.org/) — «заглушки» для функций (в конфиге `hermione.conf.js` можно подключить любую библиотеку заглушек).
<!-- - Page Object - не нужно 
пример про автораизацию -->

Рассмотрим поэтапную разработку тестов на простом примере появления колдунщика погоды:  

1. Описываем текстом пошаговый тест-план:
```
Пользователь в инпут ввел текст: погода в симферополе
Нажал кнопку «Найти»
Появился колдунщик с погодой
```

1. Создаем тестовый сценарий `test.js` c использованием `WebdriverIO` и `Chai` (в папке, указанной в секции `specs` конфига `hermione.conf.js`):

   **NB** Элементы интерфейса определяются по селектору.


```js
describe("weather", function() {
    
    it("вводим в поисковый инпут запрос: погода в симферополе", function() {
      setValue('.search2__input', 'погода в симферополе'); 
    });

    it("нажимаем кнопку «Найти», function() {
       click('.search2__button');  
    });

    it("ожидает появления элемента колдунщика", function() {
       waitForWisible ('.z-weather');  
    });
```

Если при запуске теста (`hermione/node_modules/.bin/hermione test.js`) никаких ошибок не появилось, то тест пройден успешно.

Чтобы упростить поддержку написаных тестов и уменьшить количество дублируемого кода, можно использовать популярный в автоматизированном тестировании шаблон проектирования 
[Page Object](http://selenium2.ru/docs/test-design-considerations.html#page-object). Он позволяет заменить сруктуры страницы и находить элемент не по селектору а по свойству класса page-object.... нужно описывать ???

Данный пример может быть переписан следующим образом с использованием паттерна «Page Object»: ???


<a name="get-test-data"></a>
## Генерация тестовых данных

Тестирование выполняется c использованием набора тестовых данных, которые получены автоматически при обращении к реальным источника данных сервиса. Они представляют собой стабильный набор конкретных значений для проверки некоторой функциональности приложения с заранее известным результатом.  Они нужны для следующего:

* входные данные для создания условия
* выходные данные для оценки требования
* вспомогательные данные (как предварительное условие для теста

Тестовые данные хранятся в виде дампа в файловой системе, полученного после обращения к удаленным источникам сервиса. Это позволяет их использовать повторно при выполнении тестов.

На основе тестовых данных будет сформирована тестовая страница на которой будут выполнятся тесты.
  
Подготовить тестовые данные можно с помощью кэширующего сервера (репорт), зависит от сервиса, следующим образом (отладка тестов выполняется локально):

> * СЕРП:[templar](https://github.yandex-team.ru/nodereport/templar) 
  [Подробная документация](https://wiki.yandex-team.ru/nodereport/templar/faq/)
  * Мультимедиа [node-report]() 
  Нужно описание установки,  настройки и запуска или достаточно ссылок

- Запустить все текущие тесты проекта с опцией `--play` и убедиться, что не появляются ошибки. Если есть проблемные тесты, найти его автора для исправления ошибок.

```
hermione/node_modules/.bin/hermione --play
```

- Написать тест и убедиться, что он выполняется правильно, запустив его без опций
 
```
hermione/node_modules/.bin/hermione hermione/test-suites/desktop/mytest.js
```

- Сохранить дампы данных своих тестов посредством опции `--save`. Изменения в дампах чужих тестов (пока нет опции запуска `--grep` FEI-1829[ --hermione: добавить опцию grep-- ]( matumbaman )) откатить.
decribe.only
it.only
cопцией --save сохранить данные только для отмеченных only тестов


```
hermione/node_modules/.bin/hermione hermione/test-suites/desktop/mytest.js 
``` 

- Выполнить еще раз все тесты с опцией `--play`. Убедиться, что ваши тесты  выполняются поверх сохраненных данных (в консоли не должно быть ошибок). Желательно несколько раз, особенно, если в тесте есть AJAX-запросы.   
  
- Если все тесты прошли успешно, нужно закоммитить `test-suite` и `test-data` своих тестов в репозиторий проекта. Учитывайте, что `test-data` комитится в [git-lf]()(только web4)

- В отчетах для вашего PR на GitHub-е проверьте, что ваши тесты в TeamCity прошли.


 #### Работа с кешами репорта (templar)
 
- Запуск тестов по живым данным репорта (при разработке теста):

```
hermione/node_modules/.bin/hermione
```

- Запуск поверх сохраненных ответов репорта (в частности при запуске в TeamCity):
```
hermione/node_modules/.bin/hermione --play
``` 
- Запись ответов репорта в файл (после того как написали и отладили тест), дамп ответа нужно будет закоммитить:
```
 hermione/node_modules/.bin/hermione --save
 ```

